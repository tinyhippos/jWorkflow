/*! jsFlow 2013-07-24 */
var jsFlow=function(){function a(a){if("function"!=typeof a)throw"expected function but was "+typeof a}function b(a){return"function"==typeof a.andThen&&"function"==typeof a.start&&"function"==typeof a.chill}function c(a){return!!a.map&&!!a.reduce}var d={},e={};return d.andThen=function(d,e){if(this._finalized)throw Error("flow is already finalized");var f;if(1===arguments.length&&(e=null),b(d)){var g=function(a,b){b.take(),d.start(function(a){b.pass(a)},e,a)};f=g}else if(c(d)){var h=function(a,b){b.take();var c=d.length,e=function(){return--c||b.pass()};d.forEach(function(a){jsFlow().andThen(a).start(e)})};f=h}else a(d),f=d;return this._workflow.push({func:f,context:e}),this},d.chill=function(a){if(this._finalized)throw Error("flow is already finalized");return this.andThen(function(b,c){c.take(),setTimeout(function(){c.pass(b)},a)})},d.finalize=function(){this._finalized=!0},d.start=function(a,b,c){this._finalized||(this._finalized=!0);var d=Object.create(e);if(a&&"object"==typeof a){var f=a;a=f.callback,b=f.context,c=f.initialValue}d._flow=this,d._context=b?b:null,d._callback=a?a:null,d._step=0,d._taken=!1,d.pass(c)},e.take=function(){this._taken=!0},e.pass=function(a){if(this._taken=!1,this._step<this._flow._workflow.length){var b=this._flow._workflow[this._step],c=b.context;c||(c=this._context),this._step+=1,a=b.func.call(c,a,this),this._taken||this.pass(a)}else this._callback&&this._callback.call(this._context,a)},e.revise=function(a){this._step-=1,this.pass(a)},e.drop=function(a){this._taken=!0,this._step=this._flow._workflow.length;var b=this;setTimeout(function(){b.pass(a)},1)},function(){var a=Object.create(d);return a._workflow=[],a._finalized=!1,a}}();if(JSFLOW_JWORKFLOW_API_COMPATIBLE_MODE){var jWorkflow={};jWorkflow.order=function(a,b){var c=jsFlow();return a&&c.andThen(a,b),c}}"undefined"!=typeof exports&&(exports.create=jsFlow),"object"==typeof module&&"function"==typeof require&&(module.exports=jsFlow);