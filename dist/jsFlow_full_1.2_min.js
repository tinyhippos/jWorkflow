(function(){function t(t){if("function"!=typeof t)throw"expected function but was "+typeof t}function n(t){return"function"==typeof t.andThen&&"function"==typeof t.start&&"function"==typeof t.step&&"function"==typeof t.chill}function e(t){return!!t.map&&!!t.reduce}function i(t,n){t._taken&&setTimeout(function(){t.pass(n)},1)}var o=window&&window.JSFLOW_JWORKFLOW_API_COMPATIBLE_MODE===!0,s={};s.step=function(i,o,s){if(this._finalized)throw Error("flow is already finalized");var r;if(1===arguments.length)o=i,s=null,i=null;else if(2===arguments.length)if("string"!=typeof i){var a=i,f=o;o=a,s=f,i=null}else s=null;if(n(o)){var l=function(t,n){n.take(),o.start(function(t){n.pass(t)},s,t)};r=l}else if(e(o)){var u=function(t,n){n.take();var e=o.length,i=function(){return--e||n.pass()};o.forEach(function(t){jsFlow().andThen(t).start(i)})};r=u}else t(o),r=o;return this._workflow.push({func:r,context:s}),null!==i&&(this._marks[i]=this._workflow.length-1),this},s.andThen=s.step,s.chill=function(t){if(this._finalized)throw Error("flow is already finalized");return this.andThen(function(n,e){e.take(),setTimeout(function(){e.pass(n)},t)})},s.finalize=function(){this._finalized=!0},s.start=function(t,n,e){this._finalized||(this._finalized=!0);var i=Object.create(r),o=!1;if(t&&"object"==typeof t){var s=t;t=s.callback,n=s.context,e=s.initialValue,s.asyncMode&&(o=1==s.asyncMode)}return i._workflow=this._workflow,i._marks=this._marks,i._context=n?n:null,i._callback=t?t:null,i._step=0,i._taken=!1,i._async=o,i.pass(e),i};var r={};r.take=function(){this._taken=!0},r.pass=function(t){if(this._taken=this._async,this._step<this._workflow.length){var n=this._workflow[this._step],e=n.context;e||(e=this._context),this._step+=1,t=n.func.call(e,t,this),this._taken||this.pass(t)}else this._callback&&(this._taken=!1,this._callback.call(this._context,t))},r.reset=function(t){return this._step=0,i(this,t),t},r.revise=function(t){return this._step-=1,i(this,t),t},r.nextStep=function(t,n){if(this._step=this._marks[t],"number"!=typeof this._step)throw Error("unknown mark");return i(this,n),n},r.drop=function(t){return o&&this.take(),this._step=this._workflow.length,i(this,t),t};var a=function(){var t=Object.create(s);return t._workflow=[],t._marks={},t._finalized=!1,t},f={order:function(t,n){var e=a();return t&&e.andThen(t,n),e}};"undefined"!=typeof window?(window.jsFlow=a,o&&(window.jWorkflow=f)):"undefined"!=typeof exports&&(exports.jsFlow=a,exports.jWorkflow=f)})();var jsFlowStateMachine=function(t,n){function e(t,n,e){e.context||(e.context=null),t.step(n,function(t,i){e.onenter&&e.onenter.call(this,t,i),i.state=n},e.context).step(function(t,n){n._noTransition=!0,n._taken=!1;var i=e[t];i?i.call(this,t,n):e["*"]&&e["*"].call(this,t,n),n._noTransition&&e.defaultOutcome&&n.transition(e.defaultOutcome),n._taken=!0,n._noTransition||n.pass()},e.context)}1===arguments.length&&(n=t);var i={msg:null},o=n.indexOf("ERROR");if(-1!==o){var s=n[o+1],r={};r.onenter=function(){s.onenter(i),i.msg=null},s["*"]?r.onevent=s.onevent:s.defaultOutcome?r.defaultOutcome=s.defaultOutcome:r["*"]=function(){console.error("being in error state, move manually out by transition(to);")},n[o+1]=r}else n.push("ERROR",{onenter:function(t){console.error(t)},"*":function(){console.error("being in error state, move manually out by transition(to);")}});for(var a=jsFlow().step(function(t,n){n.transition=function(t){this._noTransition=!1,this.nextStep(t)},n.sendIntoState=function(t){this.transition(t),this.pass()},n.error=function(t){n.transition("ERROR"),i.msg=t},n.event=n.pass}),f=0,l=n.length;l>f;f+=2){var u=n[f],c=n[f+1];"function"==typeof c&&(c={onevent:c}),e(a,u,c)}var h=a.start({asyncMode:!0});return h.pass(),h};